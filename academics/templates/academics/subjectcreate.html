{% extends "base.html" %}
{% block subject %}

<div class="subjectform">
  <form>
    {% csrf_token%}
  {{form.as_p}}
  <button id="subject-btn">Submit</button></form>

</div>

<div id="message">

</div>
<div class="subject-list">
</div>


<script>
  const container2 = document.querySelector('.subject-list');
  var messages = document.getElementById('message')
  url = 'https://schooltestproject.herokuapp.com/academics/subjects/'

  function get(){
  fetch(url).then(res => {
    return res.json()
  }).then(data => {
    let table2 = '<table>';
    table2 += `<thead class="thead">
      <th scope="col">grade</th>
      <th scope="col">subject code</th>
      <th scope="col">subject</th>
      <th scope="col">Edit</th>
      <th scope="col">Delete</th>
    </thead>`;
    data.forEach((d, index) => {
      table2 = table2 + `<tbody><tr id=${d.id}>`;
      table2 = table2 + '<td class="grade">' + `${d.grade}` + '</td>';
      table2 = table2 + '<td class="code">' + `${d.code}` + '</td>';
      table2 = table2 + '<td class="name">' + `${d.name}` + '</td>';
        table2 = table2 + '<td>' + `<a href=# id="edit" >Edit</a>` + '</td>',
        table2 = table2 + '<td>' + `<a href=# id="delete" >delete</a>` + '</td></tbody>',
        table2 = table2 + `</tr>`;
      })
      table2 += "</table>";
      container2.innerHTML = table2;

  })
  };
  get();

  container2.addEventListener('click',(e) => {
  form_grade = document.getElementById('id_grade')
  form_code = document.getElementById('id_code')
  form_name = document.getElementById('id_name')
  subject_btn = document.getElementById('subject-btn')
  e.preventDefault();
  let delbutton = e.target.id == 'delete';
  let editbutton = e.target.id == 'edit';
  let id = e.target.parentElement.parentElement.id;
  if(delbutton){
    const parent1 = e.target.parentElement.parentElement;
    var name = parent1.querySelector('.name').textContent
    if (confirm(`You want to delete chapter ${(e.target.parentElement.parentElement.querySelector('.name')).textContent}`)) {
      fetch(`${url}${id}/`,{
      method : 'DELETE',
      headers : {
        'Authorization':'token'+' '+token 
      },
    }).then(res => console.log(res)
  )

  }

  }

  if(editbutton){

    const parent = e.target.parentElement.parentElement;
    var grade = parent.querySelector('.grade').textContent;
    var code = parent.querySelector('.code').textContent;
    var name = parent.querySelector('.name').textContent;
    form_grade.value = grade
    form_code.value = code
    form_name.value = name

    subject_btn.addEventListener('click',()=>{
      fetch(`${url}${id}/`,{
        method : 'PUT',
        headers : {
          'content-Type' : 'application/json',
          'Authorization':'token'+' '+token 
        },
        body: JSON.stringify({
          'grade' : form_grade.value,
          'code': form_code.value,
          'name' : form_name.value,
        })
      }).then(res => res.json()).then(() => location.reload())
      
    }) 
  }
} );
  

  const subject_create = document.getElementById('subject-btn')
  subject_create.addEventListener('click',()=>{
      var code = document.getElementById('id_code').value
      var name = document.getElementById('id_name').value
      var grade = document.getElementById('id_grade').value

        fetch('https://schooltestproject.herokuapp.com/academics/subjects/',
        {
          method: 'POST',
          body: JSON.stringify({ 'code': code, 'name': name, 'grade': grade}
          ),
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'Authorization':'token'+' '+token 
          },
        }).then(function (response) {
          if (response.status == 201) {
            console.log("Sucess response", response)
            messages.innerHTML = `${name} is created succesfully`;
            get();
            return response.json();
          }else{
            console.log(response);
          }
        })
  })
  function logout(){
    let token=localStorage.getItem("token")            
    console.log(token)            
    fetch('https://schooltestproject.herokuapp.com/auth/logout/',            
    {            
    method: 'GET',            
    headers: {            
    'Content-Type': 'application/json',            
    'Authorization':'token'+' '+token,            
    // 'Content-Type': 'application/x-www-form-urlencoded',            
    }            
    }) .then(response => response.text())            
    window.location.href='login'            
    } 
</script>

{% endblock %}

{% comment %} {% extends "base.html" %}
    {% block content %}
        <div class="question">
   

    
        {{form.as_p}}

        <button id="create" onclick=createsubject()>Create</button>
    <script>
        function createsubject() {
           var grade = document.getElementById('id_grade').value
           var name = document.getElementById('id_name').value
           var code = document.getElementById('id_code').value
           fetch('https://schooltestproject.herokuapp.com/academics/subjects/',
                {
               method: 'POST',
               body: JSON.stringify({ 'grade': grade, 'name':name,'code':code}
               ),
               headers: {
                   'Accept':'application/json',
                   'Content-Type': 'application/json'
               },
           }).then(function(response) {
               if (response.ok) {
                   console.log("Sucess response",response)
                   return response.json();
               } else {
                   throw new Error("Could not reach the API: " + response.statusText);
               }
           }).then(function(data) {
           }).catch(function(error) {
              console.log(error.message)
           });
       return true;
    }

    </script>
  </div>
    

       
            
  
  <div>
    <table class="table">
      <thead class="thead">
        <tr>
          <th scope="col">Subject</th>
          <th scope="col">Code</th>
          <th scope="col">Grade</th>
          <th scope="col">Actions</th>
      
        </tr>
      </thead>             
      
      {% for l in subject %}       
      <tbody> 
        <tr>                       
          <td>{{l.name}}</td>
          <td>{{l.code}}</td>
          <td>{{l.grade}}</td>
          <td><button class="update" onclick=update({{l.id}})>Update</a></button>
              <button class="delete"><a href="">Delete</a></button></td>
        </tr> 
        {% endfor %}                
      </tbody>
    </table>
            
                    
                         
          
      
           
        
  
        
          
        </div> {% endcomment %}
     